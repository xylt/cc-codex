# AI Code Mirror 阿里云 ECS 部署文档

## 目录
- [服务器要求](#服务器要求)
- [准备工作](#准备工作)
- [首次部署](#首次部署)
- [日常更新部署](#日常更新部署)
- [常见问题](#常见问题)
- [监控与维护](#监控与维护)

---

## 服务器要求

### 最低配置
- **CPU**: 2核
- **内存**: 4GB
- **磁盘**: 40GB SSD
- **操作系统**: Ubuntu 20.04 LTS 或 Ubuntu 22.04 LTS
- **带宽**: 3Mbps

### 推荐配置
- **CPU**: 4核
- **内存**: 8GB
- **磁盘**: 80GB SSD
- **操作系统**: Ubuntu 22.04 LTS
- **带宽**: 5Mbps

---

## 准备工作

### 1. 购买阿里云 ECS

1. 登录 [阿里云控制台](https://ecs.console.aliyun.com/)
2. 选择"云服务器 ECS" → "实例与镜像" → "实例"
3. 点击"创建实例"
4. 配置选择:
   - 地域: 选择离用户最近的地域
   - 实例规格: ecs.c6.large (2核4GB) 或更高
   - 镜像: Ubuntu 22.04 64位
   - 存储: 系统盘 40GB SSD
   - 网络: 按使用流量计费或固定带宽
   - 安全组: 放通 22(SSH)、80(HTTP)、443(HTTPS)

### 2. 配置域名（可选但推荐）

1. 在阿里云购买域名或使用已有域名
2. 添加 A 记录指向 ECS 公网 IP
   - 主机记录: `@` 或 `www`
   - 记录类型: `A`
   - 记录值: ECS 公网 IP
   - TTL: 10分钟

### 3. 连接服务器

```bash
# Windows 使用 PowerShell 或 PuTTY
ssh root@your-server-ip

# 首次登录需要修改密码
passwd
```

---

## 首次部署

### 步骤 1: 上传项目文件

#### 方法一: 使用 Git（推荐）

```bash
# 1. 在本地初始化 Git（如果还没有）
cd C:\Project\镜像网站\aicode-mirror
git init
git add .
git commit -m "Initial commit"

# 2. 推送到 Git 仓库（GitHub/Gitee/GitLab）
git remote add origin your-git-repo-url
git push -u origin master

# 3. 在服务器上克隆（稍后在初始化脚本中执行）
```

#### 方法二: 使用 SCP 上传

```bash
# Windows 使用 PowerShell
scp -r C:\Project\镜像网站\aicode-mirror root@your-server-ip:/var/www/

# Linux/Mac
scp -r /path/to/aicode-mirror root@your-server-ip:/var/www/
```

### 步骤 2: 运行初始化脚本

```bash
# 连接到服务器
ssh root@your-server-ip

# 赋予执行权限
cd /var/www/aicode-mirror
chmod +x setup-server.sh

# 运行初始化脚本
./setup-server.sh
```

脚本会自动安装:
- ✅ Node.js 18.x
- ✅ PM2 进程管理器
- ✅ Nginx 反向代理
- ✅ MongoDB (可选)
- ✅ 防火墙配置

### 步骤 3: 配置环境变量

```bash
cd /var/www/aicode-mirror/backend

# 编辑生产环境配置
vim .env.production
```

**重要配置项:**

```bash
# 生产环境
NODE_ENV=production

# 服务器端口
PORT=3001

# MongoDB 连接（如果使用本地数据库）
MONGODB_URI=mongodb://localhost:27017/aicode-mirror

# JWT 密钥（必须修改！）
JWT_SECRET=your-super-secret-key-change-this-now-$(openssl rand -hex 32)

# CORS 允许的域名
CORS_ORIGIN=http://your-domain.com

# API Key 生成服务
API_KEY_GENERATION_URL=http://claudeai.asia:8080/admin/api-keys
```

### 步骤 4: 配置 Nginx

```bash
# 复制配置文件
cp /var/www/aicode-mirror/nginx.conf /etc/nginx/sites-available/aicode-mirror

# 修改域名
vim /etc/nginx/sites-available/aicode-mirror
# 将 your-domain.com 替换为你的实际域名

# 创建软链接
ln -s /etc/nginx/sites-available/aicode-mirror /etc/nginx/sites-enabled/

# 删除默认配置
rm /etc/nginx/sites-enabled/default

# 测试配置
nginx -t

# 重启 Nginx
systemctl restart nginx
```

### 步骤 5: 构建前端

```bash
cd /var/www/aicode-mirror/frontend

# 安装依赖
npm install

# 构建生产版本
npm run build

# 验证构建结果
ls -la dist/
```

### 步骤 6: 启动后端服务

```bash
cd /var/www/aicode-mirror/backend

# 安装依赖
npm install --production

# 创建日志目录
mkdir -p logs

# 使用 PM2 启动
npm run pm2:start

# 查看状态
pm2 status

# 保存 PM2 配置（开机自启）
pm2 save
```

### 步骤 7: 验证部署

```bash
# 1. 检查后端健康
curl http://localhost:3001/health

# 2. 检查 PM2 状态
pm2 status

# 3. 检查 Nginx 状态
systemctl status nginx

# 4. 访问网站
# 浏览器打开: http://your-server-ip 或 http://your-domain.com
```

---

## 日常更新部署

当代码有更新时，使用部署脚本快速更新：

```bash
# 连接到服务器
ssh root@your-server-ip

# 进入项目目录
cd /var/www/aicode-mirror

# 赋予执行权限（首次）
chmod +x deploy.sh

# 运行部署脚本
./deploy.sh
```

部署脚本会自动:
1. ✅ 拉取最新代码
2. ✅ 安装依赖
3. ✅ 构建前端
4. ✅ 重启后端服务
5. ✅ 重启 Nginx

**手动部署步骤:**

```bash
# 1. 拉取代码
git pull origin master

# 2. 更新前端
cd frontend
npm install
npm run build

# 3. 更新后端
cd ../backend
npm install --production

# 4. 重启服务
pm2 restart aicode-mirror-backend

# 5. 重启 Nginx
nginx -t && systemctl reload nginx
```

---

## 配置 HTTPS（推荐）

### 方法一: 使用 Let's Encrypt 免费证书

```bash
# 1. 安装 Certbot
apt install -y certbot python3-certbot-nginx

# 2. 获取证书（自动配置 Nginx）
certbot --nginx -d your-domain.com -d www.your-domain.com

# 3. 测试自动续期
certbot renew --dry-run

# 证书会自动续期，无需手动操作
```

### 方法二: 使用阿里云 SSL 证书

1. 在阿里云购买或申请免费 SSL 证书
2. 下载 Nginx 格式证书
3. 上传到服务器 `/etc/nginx/ssl/`
4. 修改 nginx.conf 启用 HTTPS 配置
5. 重启 Nginx

---

## 监控与维护

### PM2 常用命令

```bash
# 查看所有进程
pm2 status

# 查看日志
pm2 logs aicode-mirror-backend

# 实时日志
pm2 logs aicode-mirror-backend --lines 100

# 重启服务
pm2 restart aicode-mirror-backend

# 停止服务
pm2 stop aicode-mirror-backend

# 删除服务
pm2 delete aicode-mirror-backend

# 查看详细信息
pm2 show aicode-mirror-backend

# 监控面板
pm2 monit
```

### 日志查看

```bash
# 后端日志
tail -f /var/www/aicode-mirror/backend/logs/combined.log
tail -f /var/www/aicode-mirror/backend/logs/err.log

# Nginx 日志
tail -f /var/log/nginx/aicode-mirror-access.log
tail -f /var/log/nginx/aicode-mirror-error.log

# PM2 日志
pm2 logs --lines 200
```

### 系统监控

```bash
# CPU 和内存使用
htop

# 磁盘使用
df -h

# 网络连接
netstat -tulpn | grep LISTEN

# 进程列表
ps aux | grep node
```

### 数据库备份（如果使用 MongoDB）

```bash
# 备份数据库
mongodump --db aicode-mirror --out /backup/$(date +%Y%m%d)

# 恢复数据库
mongorestore --db aicode-mirror /backup/20231201/aicode-mirror

# 定时备份（添加到 crontab）
crontab -e
# 添加: 0 2 * * * mongodump --db aicode-mirror --out /backup/$(date +\%Y\%m\%d)
```

---

## 常见问题

### 1. 端口被占用

```bash
# 查看占用端口的进程
lsof -i :3001

# 杀死进程
kill -9 PID
```

### 2. Nginx 502 Bad Gateway

```bash
# 检查后端服务是否运行
pm2 status

# 检查后端日志
pm2 logs aicode-mirror-backend

# 重启后端
pm2 restart aicode-mirror-backend
```

### 3. 前端页面空白

```bash
# 检查 dist 目录是否存在
ls -la /var/www/aicode-mirror/frontend/dist/

# 重新构建前端
cd /var/www/aicode-mirror/frontend
npm run build

# 检查 Nginx 配置
nginx -t
```

### 4. 内存不足

```bash
# 查看内存使用
free -h

# 清理缓存
sync; echo 3 > /proc/sys/vm/drop_caches

# 调整 PM2 实例数（减少到 1）
# 编辑 ecosystem.config.cjs
instances: 1
```

### 5. MongoDB 连接失败

```bash
# 检查 MongoDB 状态
systemctl status mongod

# 启动 MongoDB
systemctl start mongod

# 查看 MongoDB 日志
tail -f /var/log/mongodb/mongod.log
```

### 6. Git pull 失败

```bash
# 查看 Git 状态
git status

# 强制拉取（慎用！）
git fetch --all
git reset --hard origin/master

# 或者暂存本地修改
git stash
git pull
git stash pop
```

---

## 性能优化

### 1. 启用 Gzip 压缩

已在 nginx.conf 中配置，确保启用。

### 2. 配置 CDN（可选）

使用阿里云 CDN 加速静态资源:
1. 在阿里云开通 CDN 服务
2. 添加加速域名
3. 配置回源地址为 ECS IP
4. 更新 DNS 解析到 CDN CNAME

### 3. 数据库优化

```bash
# MongoDB 创建索引
mongo
use aicode-mirror
db.users.createIndex({ email: 1 }, { unique: true })
db.apikeys.createIndex({ userId: 1 })
```

### 4. PM2 集群模式

已在 ecosystem.config.cjs 中配置为 2 实例，可根据 CPU 核心数调整。

---

## 安全建议

1. ✅ 定期更新系统: `apt update && apt upgrade`
2. ✅ 配置防火墙（UFW）
3. ✅ 使用 HTTPS
4. ✅ 定期备份数据库
5. ✅ 使用强密码和 SSH 密钥
6. ✅ 禁用 root 密码登录
7. ✅ 安装 fail2ban 防暴力破解
8. ✅ 定期查看日志

---

## 回滚步骤

如果新版本出现问题，可以快速回滚:

```bash
# 1. 查看 Git 历史
git log --oneline -10

# 2. 回滚到上一个版本
git reset --hard HEAD~1

# 3. 重新部署
./deploy.sh

# 或者回滚到特定版本
git reset --hard commit-hash
./deploy.sh
```

---

## 联系支持

如遇到部署问题，请联系:
- 微信: aicode-support
- Email: support@aicodemirror.com

---

## 附录: 完整部署检查清单

- [ ] 服务器已购买并可访问
- [ ] 域名已配置（可选）
- [ ] 上传项目文件
- [ ] 运行 setup-server.sh
- [ ] 配置 .env.production
- [ ] 配置 Nginx
- [ ] 构建前端
- [ ] 启动后端
- [ ] 验证部署成功
- [ ] 配置 HTTPS（推荐）
- [ ] 设置定时备份
- [ ] 配置监控告警

完成以上步骤，你的 AI Code Mirror 项目就成功部署到阿里云了！
