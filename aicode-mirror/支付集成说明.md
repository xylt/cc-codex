# 支付集成说明文档

## 概述

已成功集成支付宝支付功能到 Dashboard 页面，支付成功后自动生成 API Key。

## 功能特性

### 1. 套餐方案
- **FREE**: ¥0/月，每日 3000 积分
- **PLUS**: ¥99/月，每日 5000 积分
- **PRO**: ¥199/月，每日 10000 积分

### 2. 支付流程

```
用户点击"立即升级"
    ↓
选择支付方式（支付宝/微信）
    ↓
生成支付二维码
    ↓
扫码支付
    ↓
轮询检查支付状态
    ↓
支付成功回调
    ↓
自动生成 API Key
    ↓
更新用户订阅状态
```

## API 接口

### 1. 创建支付订单
**端点**: `POST /api/payment/create`

**请求体**:
```json
{
  "userId": "用户ID",
  "plan": "plus|pro",
  "paymentMethod": "alipay|wechat"
}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "orderId": "ORDER-1234567890-ABCDEFGHI",
    "qrCodeUrl": "https://...",
    "amount": 99,
    "plan": "plus",
    "paymentMethod": "alipay"
  }
}
```

### 2. 检查支付状态
**端点**: `POST /api/payment/check`

**请求体**:
```json
{
  "orderId": "ORDER-1234567890-ABCDEFGHI"
}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "orderId": "ORDER-1234567890-ABCDEFGHI",
    "status": "pending|success|failed",
    "message": "等待支付中"
  }
}
```

### 3. 支付成功回调
**端点**: `POST /api/payment/success`

**请求体**:
```json
{
  "userId": "用户ID",
  "plan": "plus|pro",
  "orderId": "ORDER-1234567890-ABCDEFGHI",
  "paymentMethod": "alipay|wechat"
}
```

**响应**:
```json
{
  "success": true,
  "message": "支付成功，订阅已激活",
  "data": {
    "plan": "plus",
    "apiKey": "cr_442f044afc6176b649c2ca4df6707f0c...",
    "expiresAt": "2025-11-05T01:40:04.172Z",
    "credits": {
      "total": 5000,
      "remaining": 5000
    }
  }
}
```

### 4. 获取用户订阅信息
**端点**: `GET /api/payment/subscription/:userId`

**响应**:
```json
{
  "success": true,
  "data": {
    "plan": "plus",
    "subscription": {
      "planId": "plus",
      "status": "active",
      "currentPeriodStart": "2025-10-05T00:00:00.000Z",
      "currentPeriodEnd": "2025-11-05T00:00:00.000Z",
      "orderId": "ORDER-1234567890-ABCDEFGHI",
      "paymentMethod": "alipay",
      "apiKeyId": "2965f3fc-4add-40cf-b7aa-59094deb910c"
    },
    "credits": {
      "total": 5000,
      "used": 0,
      "remaining": 5000,
      "resetDate": "2025-11-05T00:00:00.000Z"
    }
  }
}
```

## API Key 生成配置

根据文档 `支付成功后调用.md` 的要求，支付成功后会调用 `http://claudeai.asia:8080/admin/api-keys` 生成 API Key。

### PLUS 方案配置
```javascript
{
  dailyCostLimit: 10,
  totalCostLimit: 50,
  rateLimitRequests: 3,
  rateLimitWindow: 1,
  expirationMode: "fixed",
  expiresAt: "当前时间 + 1个月"
}
```

### PRO 方案配置
```javascript
{
  dailyCostLimit: 20,
  totalCostLimit: 100,
  rateLimitRequests: 3,
  rateLimitWindow: 1,
  expirationMode: "fixed",
  expiresAt: "当前时间 + 1个月"
}
```

## 前端实现

### Dashboard.vue 关键方法

#### 1. 显示支付模态框
```javascript
showPaymentModal(plan) {
  this.selectedPlan = plan
  this.showPayment = true
}
```

#### 2. 生成支付二维码
```javascript
async generatePaymentQRCode() {
  const response = await fetch('/api/payment/create', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      userId: this.user.id,
      plan: this.selectedPlan,
      paymentMethod: this.paymentMethod
    })
  })
  const data = await response.json()
  this.qrCodeUrl = data.data.qrCodeUrl
  this.orderId = data.data.orderId
  this.startPaymentStatusCheck()
}
```

#### 3. 轮询支付状态
```javascript
startPaymentStatusCheck() {
  this.paymentCheckInterval = setInterval(async () => {
    const response = await fetch('/api/payment/check', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ orderId: this.orderId })
    })
    const data = await response.json()

    if (data.data.status === 'success') {
      await this.handlePaymentSuccess()
      // 更新UI和订阅状态
    }
  }, 3000)
}
```

#### 4. 处理支付成功
```javascript
async handlePaymentSuccess() {
  const response = await fetch('/api/payment/success', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      userId: this.user.id,
      plan: this.selectedPlan,
      orderId: this.orderId,
      paymentMethod: this.paymentMethod
    })
  })
  const data = await response.json()
  // 自动添加生成的 API Key 到列表
}
```

## 后端部署步骤

### 1. 安装依赖
```bash
cd backend
npm install
```

这会自动安装新添加的 `axios` 依赖。

### 2. 启动服务器
```bash
npm run dev
```

### 3. 验证路由
访问 http://localhost:3001/health 确认服务器运行正常。

## 注意事项

### 1. 真实支付接口集成
当前使用模拟的二维码和支付状态。生产环境需要：
- 集成真实的支付宝 SDK
- 集成真实的微信支付 SDK
- 配置支付回调 URL
- 实现支付签名验证

### 2. 安全性
- 支付回调应该验证签名
- 使用 HTTPS
- 订单 ID 应该防止重放攻击
- API Key 生成失败需要回滚订单

### 3. 错误处理
- 支付超时处理
- API Key 生成失败处理
- 网络异常处理
- 用户余额不足处理

### 4. 测试要点
- 测试支付成功流程
- 测试支付失败流程
- 测试支付超时
- 测试重复支付
- 测试 API Key 生成
- 测试订阅状态更新

## 文件清单

### 后端文件
- `/backend/src/controllers/paymentController.js` - 支付控制器
- `/backend/src/routes/payment.js` - 支付路由
- `/backend/src/models/User.js` - 用户模型（已更新）
- `/backend/server.js` - 服务器入口（已更新）
- `/backend/package.json` - 依赖配置（已添加 axios）

### 前端文件
- `/frontend/src/views/Dashboard.vue` - Dashboard 页面（已更新）
- `/frontend/src/views/Pricing.vue` - 定价页面（已更新）

## 后续优化建议

1. **支付方式扩展**: 添加更多支付方式（银行卡、PayPal等）
2. **订阅管理**: 添加取消订阅、续费提醒功能
3. **发票系统**: 集成电子发票生成
4. **优惠券系统**: 支持优惠码和折扣
5. **订阅历史**: 显示支付历史记录
6. **自动续费**: 实现自动扣款功能
7. **退款功能**: 支持退款申请和处理
